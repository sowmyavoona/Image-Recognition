% A word from Jesse: Loading database is a common step in testing, so I
% saved the variables and loaded them from there. This helps skipping this
% first part of the code. From second time, please run from the next
% section.

nsubjects = 18; %nc
ntrain = 1; %nstr
nsamples = 10; %ts
ntest = 9; %nsts
normalizeFlag = 0;
%% load database
[loaddb_train, loaddb_test, folder_name, row, col, ext, trainLabel] = load_database(nsubjects, ntrain, ntest, nsamples);


save Variables/loaddb_train.mat loaddb_train;
save Variables/loaddb_test.mat loaddb_test;
save Variables/folder_name folder_name;
save Variables/row row;
save Variables/col col;
save Variables/ext ext;
save Variables/trainLabel trainLabel;
save Variables/nsubjects nsubjects;
save Variables/nsamples nsamples;
save Variables/ntrain ntrain;
save Variables/ntest ntest;

%%
load Variables/normalized_train;
load Variables/normalized_test;
load Variables/loaddb_train;
load Variables/loaddb_test;
load Variables/folder_name;
load Variables/row;
load Variables/col;
load Variables/ext;
load Variables/trainLabel;
load Variables/testLabel;
load Variables/nsubjects;
load Variables/nsamples;
load Variables/ntrain;
load Variables/ntest;

%% normalize

if(normalizeFlag == 1)
    normalized_train = normalize(loaddb_train);
    normalized_test = normalize(loaddb_test);
elseif(normalizeFlag == 0)
    normalized_train = (loaddb_train);
    normalized_test = (loaddb_test);
end

save Variables/normalized_train.mat normalized_train;
save Variables/normalized_test.mat  normalized_test;

%%
load Variables/normalized_train;
load Variables/normalized_test;

%% gabor train

tic;
%[train, test] = gabor_train(nsubjects, ntrain, ntest, loaddb_train, loaddb_test, row, col, trainLabel);
[train, test] = gabor_train(nsubjects, ntrain, ntest, normalized_train, normalized_test, row, col, trainLabel);
time = toc;

save Variables/gabor_train train
save Variables/gabor_test test

disp(strcat('gabor train completed in _', num2str(time)));

%% 

load Variables/gabor_train
load Variables/gabor_test

%% DTW 

%found = dtwrecognition2(folder_name, nsubjects, nsamples, ext, ntrain, ntest, train, test, loaddb_test, row, col);	
matchPercent = dtwRecognition(nsubjects, ntrain, ntest, train, test);
disp(matchPercent);
msgbox(strcat('Gabor+DTW PERFORMANCE : ',num2str(matchPercent)),'PERFORMANCE');
			